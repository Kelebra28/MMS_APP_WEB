<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Órdenes de Trabajo • Taller</title>
  <style>
    :root{
      --bg:#0b0b0d;
      --panel:#111116;
      --text:#f2f2f3;
      --muted:#a7a7ad;
      --line:#24242c;
      --radius:16px;
      --shadow: 0 10px 30px rgba(0,0,0,.45);
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:var(--sans);
      color:var(--text);
      background: radial-gradient(1200px 700px at 20% 0%, #141420 0%, var(--bg) 55%, #070708 100%);
      min-height:100vh;
    }

    .app{
      max-width:1100px;
      margin:0 auto;
      padding:28px 18px 60px;
    }

    /* TOPBAR */
    .topbar{
      display:flex;
      gap:14px;
      align-items:center;
      justify-content:space-between;
      padding:16px 18px;
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      position:sticky;
      top:12px;
      backdrop-filter: blur(10px);
      z-index:20;
    }

    .brand{
      display:flex; align-items:center; gap:12px;
      min-width: 220px;
    }
    .logo{
      width:42px; height:42px; border-radius:14px;
      background: linear-gradient(135deg, rgba(255,255,255,.9), rgba(255,255,255,.25));
      box-shadow: 0 10px 25px rgba(255,255,255,.08);
      flex: 0 0 auto;
    }
    .brand h1{
      font-size:14px; margin:0; letter-spacing:.4px; font-weight:650;
    }
    .brand p{
      margin:2px 0 0; font-size:12px; color:var(--muted);
    }

    .actions{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      justify-content:flex-end;
    }

    .btn{
      appearance:none;
      border:1px solid var(--line);
      background:rgba(255,255,255,.04);
      color:var(--text);
      padding:10px 12px;
      border-radius:14px;
      cursor:pointer;
      font-weight:600;
      letter-spacing:.2px;
      transition:.15s ease;
      display:inline-flex; align-items:center; justify-content:center; gap:8px;
      min-height: 40px;
    }
    .btn:hover{ transform: translateY(-1px); background:rgba(255,255,255,.06); }
    .btn.primary{
      background:rgba(255,255,255,.92);
      color:#0b0b0d;
      border-color:transparent;
    }
    .btn.primary:hover{ background:#fff; }
    .btn.danger{
      background: rgba(255, 124, 124, .14);
      border-color: rgba(255, 124, 124, .35);
    }

    .pill{
      font-family:var(--mono);
      font-size:11px;
      color:var(--muted);
      border:1px solid var(--line);
      padding:8px 10px;
      border-radius:999px;
      background:rgba(0,0,0,.25);
      white-space:nowrap;
    }

    /* LAYOUT GRID (desktop + tablet landscape) */
    .grid{
      display:grid;
      grid-template-columns: 360px 1fr;
      gap:14px;
      margin-top:16px;
    }

    /* CARD */
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
      min-width: 0;
    }

    .card .head{
      padding:14px 16px;
      border-bottom:1px solid var(--line);
      display:flex; justify-content:space-between; align-items:center;
      gap:12px;
    }
    .card .head h2{
      margin:0;
      font-size:13px;
      letter-spacing:.4px;
      text-transform:uppercase;
      color:rgba(255,255,255,.92);
    }
    .card .body{
      padding:14px 16px 18px;
    }

    .step{
      display:flex; gap:10px; align-items:center;
      color:var(--muted);
      font-size:12px;
      margin-bottom:12px;
    }
    .step b{ color:var(--text); }

    .input, .select, textarea{
      width:100%;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.28);
      color:var(--text);
      outline:none;
      transition:.15s ease;
      min-height: 44px; /* táctil */
    }
    textarea{ min-height: 110px; resize: vertical; }
    .input:focus, .select:focus, textarea:focus{
      border-color: rgba(255,255,255,.25);
      box-shadow: 0 0 0 4px rgba(255,255,255,.06);
    }

    .label{
      font-size:12px;
      color:var(--muted);
      margin:12px 0 6px;
      display:flex; justify-content:space-between;
      gap:8px;
    }

    .list{
      display:flex; flex-direction:column; gap:8px;
      margin-top:10px;
      max-height: 380px;
      overflow:auto;
      padding-right: 6px;
    }
    .item{
      padding:10px 12px;
      border:1px solid var(--line);
      border-radius:14px;
      background: rgba(255,255,255,.03);
      cursor:pointer;
      transition:.15s ease;
      display:flex; align-items:center; justify-content:space-between;
      gap:10px;
    }
    .item:hover{ background: rgba(255,255,255,.05); transform: translateY(-1px); }
    .item .name{ font-weight:650; font-size:13px; }
    .item .meta{ font-family:var(--mono); font-size:11px; color:var(--muted); }

    .jobTypes{
      display:grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap:10px;
    }

    .jobCard{
      border:1px solid var(--line);
      border-radius:16px;
      padding:12px;
      background: rgba(0,0,0,.22);
      cursor:pointer;
      transition:.15s ease;
      min-width: 0;
    }
    .jobCard:hover{ transform: translateY(-1px); background: rgba(255,255,255,.04); }
    .jobCard.active{
      border-color: rgba(255,255,255,.35);
      box-shadow: 0 0 0 4px rgba(255,255,255,.06);
    }
    .jobCard h3{ margin:0; font-size:13px; letter-spacing:.3px; }
    .jobCard p{ margin:6px 0 0; font-size:12px; color:var(--muted); }

    .formGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }

    .sectionTitle{
      margin:14px 0 6px;
      font-size:12px;
      color:rgba(255,255,255,.9);
      text-transform:uppercase;
      letter-spacing:.35px;
    }
    .divider{
      height:1px;
      background: var(--line);
      margin:12px 0;
    }

    .checks{
      display:grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap:8px;
      margin-top:8px;
    }
    .check{
      display:flex; gap:10px; align-items:center;
      border:1px solid var(--line);
      border-radius:14px;
      padding:10px 12px;
      background: rgba(255,255,255,.03);
      min-height: 44px;
    }
    .check input{ transform: scale(1.15); }

    .hint{
      font-size:12px;
      color:var(--muted);
      line-height:1.45;
      margin-top:10px;
    }

    .history{
      display:flex; flex-direction:column; gap:8px;
      max-height: 360px;
      overflow:auto;
      padding-right: 6px;
    }
    .row{
      display:flex; gap:10px; justify-content:space-between; align-items:flex-start;
      border:1px solid var(--line);
      border-radius:14px;
      padding:10px 12px;
      background: rgba(255,255,255,.03);
      cursor:pointer;
      transition:.15s ease;
    }
    .row:hover{ background: rgba(255,255,255,.05); transform: translateY(-1px); }
    .row .left{ display:flex; flex-direction:column; gap:4px; min-width:0; }
    .row .right{ text-align:right; font-family:var(--mono); font-size:11px; color:var(--muted); }
    .tag{
      display:inline-flex;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.22);
      font-size:11px;
      color: var(--muted);
      width: fit-content;
      flex: 0 0 auto;
    }

    /* ===========================
       RESPONSIVE BREAKPOINTS
       =========================== */

    /* Tablet portrait + pantallas medianas */
    @media (max-width: 980px){
      .app{ padding:18px 14px 44px; }
      .grid{ grid-template-columns: 1fr; }
      .topbar{ position:relative; top:auto; }
      .jobTypes{ grid-template-columns: repeat(2, minmax(0, 1fr)); }
      .brand{ min-width: 0; }
    }

    /* Tablet landscape específico (tipo iPad horizontal) */
    @media (min-width: 768px) and (max-width: 1024px) and (orientation: landscape){
      .grid{
        grid-template-columns: 330px 1fr;
      }
      .jobTypes{ grid-template-columns: repeat(4, minmax(0, 1fr)); }
      .list{ max-height: 320px; }
      .history{ max-height: 300px; }
    }

    /* Celular */
    @media (max-width: 560px){
      .topbar{
        flex-direction:column;
        align-items:stretch;
        gap:12px;
      }
      .actions{
        display:grid;
        grid-template-columns: 1fr 1fr;
        gap:10px;
        justify-content:stretch;
      }
      #sessionPill{
        grid-column: 1 / -1;
        justify-self: stretch;
        text-align:center;
      }
      .btn{ width:100%; }
      .jobTypes{ grid-template-columns: 1fr; }
      .formGrid{ grid-template-columns: 1fr; }
      .checks{ grid-template-columns: 1fr; }
      .list{ max-height: 260px; }
      .history{ max-height: 240px; }
    }

    /* Modo impresión */
    @media print{
      body{ background:#fff; }
      .topbar, .grid, .no-print{ display:none !important; }
      .printArea{
        display:block !important;
        color:#000;
        padding:0;
        max-width: 800px;
        margin: 0 auto;
      }
      .printCard{
        border:1px solid #000;
        padding:14px;
        border-radius:0;
        box-shadow:none;
        background:#fff;
      }
      .printCard h2{ margin:0 0 10px; }
      .printGrid{ display:grid; grid-template-columns: 1fr 1fr; gap:8px; }
      .printLine{ border-bottom:1px solid #000; padding:6px 0; }
      .printSmall{ font-size:12px; }
    }

    .printArea{ display:none; }
  </style>
</head>

<body>
  <div class="app">
    <div class="topbar">
      <div class="brand">
        <div class="logo"></div>
        <div>
          <h1>Órdenes de Trabajo • Taller</h1>
          <p>Negro elegante • rápido • sin complicaciones</p>
        </div>
      </div>

      <div class="actions">
        <span class="pill" id="sessionPill">Empleado: — • Trabajo: —</span>
        <button class="btn" id="btnNew">Nuevo</button>
        <button class="btn" id="btnPrint">Imprimir</button>
        <button class="btn danger" id="btnClear">Borrar historial</button>
        <button class="btn primary" id="btnSave">Guardar orden</button>
      </div>
    </div>

    <div class="grid">
      <!-- LEFT -->
      <div class="card">
        <div class="head">
          <h2>Empleado</h2>
          <span class="pill" id="employeeCount">—</span>
        </div>
        <div class="body">
          <div class="step"><b>1)</b> Busca y selecciona al trabajador</div>
          <input class="input" id="employeeSearch" placeholder="Buscar: empleado 1, empleado 2..." />
          <div class="list" id="employeeList"></div>

          <div class="divider"></div>

          <div class="head" style="padding:0 0 10px; border:0;">
            <h2 style="margin:0;">Historial</h2>
            <span class="pill" id="historyCount">—</span>
          </div>
          <div class="history" id="historyList"></div>

          <p class="hint">Tip: toca un registro del historial para cargarlo y reimprimirlo.</p>
        </div>
      </div>

      <!-- RIGHT -->
      <div class="card">
        <div class="head">
          <h2>Orden</h2>
          <span class="pill" id="orderPill">Folio: —</span>
        </div>
        <div class="body">
          <div class="step"><b>2)</b> Elige el tipo de trabajo</div>
          <div class="jobTypes" id="jobTypes"></div>

          <div class="divider"></div>

          <div class="step"><b>3)</b> Llena el formato</div>
          <div id="formArea"></div>

          <p class="hint">
            Guardado local (en esta compu). Si luego quieres: exportar a Excel/Sheets o PDF automático, lo agregamos.
          </p>
        </div>
      </div>
    </div>

    <!-- PRINT -->
    <div class="printArea" id="printArea">
      <div class="printCard">
        <h2 id="pTitle">Orden de Trabajo</h2>
        <div class="printSmall" id="pMeta"></div>
        <div style="height:10px"></div>
        <div class="printGrid" id="pGrid"></div>
        <div style="height:10px"></div>
        <div id="pNotes"></div>
      </div>
    </div>
  </div>

  <script>
    const EMPLOYEES = [
      { id: "E01", name: "Empleado 1" },
      { id: "E02", name: "Empleado 2" },
      { id: "E03", name: "Empleado 3" },
      { id: "E04", name: "Empleado 4" },
      { id: "E05", name: "Empleado 5" },
    ];

    const JOB_TYPES = [
      { key: "acabado", title: "Acabado", desc: "Acabado + Alce + Cantidad + Empacado + Acabado final" },
      { key: "suaje", title: "Suaje", desc: "Suajista + Original + Trazo/Dibujo + Sacabocado/Perforado..." },
      { key: "impresion", title: "Impresión", desc: "Prensista + Tiro + Frente/Vuelta + Placas/Tintas/Barniz" },
      { key: "maquina_suaje", title: "Máquina de suaje", desc: "Formato rápido: Tiro + Arreglos + Folio + Observaciones" }
    ];

    const LS_KEY = "taller_orders_v1";

    let state = {
      employee: null,
      jobType: null,
      order: {
        folio: null,
        createdAt: null,
        numero: "",
        fecha: "",
        trabajo: "",
        cliente: "",
        data: {}
      }
    };

    const $ = (sel) => document.querySelector(sel);

    function uid(){
      const d = new Date();
      const pad = (n)=> String(n).padStart(2,"0");
      return `OT-${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}-${pad(d.getHours())}${pad(d.getMinutes())}${pad(d.getSeconds())}`;
    }

    function loadAll(){
      try{ return JSON.parse(localStorage.getItem(LS_KEY) || "[]"); }
      catch{ return []; }
    }
    function saveAll(list){ localStorage.setItem(LS_KEY, JSON.stringify(list)); }

    function resetOrder(){
      state.jobType = null;
      state.order = {
        folio: uid(),
        createdAt: new Date().toISOString(),
        numero: "",
        fecha: new Date().toISOString().slice(0,10),
        trabajo: "",
        cliente: "",
        data: {}
      };
      renderSession();
      renderJobTypes();
      renderForm();
      $("#orderPill").textContent = `Folio: ${state.order.folio}`;
    }

    function renderSession(){
      const emp = state.employee ? `${state.employee.name} (${state.employee.id})` : "—";
      const job = state.jobType ? JOB_TYPES.find(j=>j.key===state.jobType)?.title : "—";
      $("#sessionPill").textContent = `Empleado: ${emp} • Trabajo: ${job}`;
    }

    function renderEmployees(filter=""){
      const list = $("#employeeList");
      const f = filter.trim().toLowerCase();
      const items = EMPLOYEES.filter(e => e.name.toLowerCase().includes(f) || e.id.toLowerCase().includes(f));

      $("#employeeCount").textContent = `${items.length} / ${EMPLOYEES.length}`;
      list.innerHTML = "";

      items.forEach(emp=>{
        const div = document.createElement("div");
        div.className = "item";
        div.innerHTML = `
          <div>
            <div class="name">${emp.name}</div>
            <div class="meta">${emp.id}</div>
          </div>
          <div class="tag">${state.employee?.id === emp.id ? "Seleccionado" : "Elegir"}</div>
        `;
        div.onclick = () => {
          state.employee = emp;
          renderEmployees($("#employeeSearch").value);
          renderSession();
        };
        list.appendChild(div);
      });
    }

    function renderJobTypes(){
      const wrap = $("#jobTypes");
      wrap.innerHTML = "";
      JOB_TYPES.forEach(j=>{
        const div = document.createElement("div");
        div.className = "jobCard" + (state.jobType===j.key ? " active" : "");
        div.innerHTML = `<h3>${j.title}</h3><p>${j.desc}</p>`;
        div.onclick = () => {
          state.jobType = j.key;
          state.order.data = buildDefaultData(j.key, state.order.data);
          renderJobTypes();
          renderForm();
          renderSession();
        };
        wrap.appendChild(div);
      });
    }

    function buildDefaultData(type, prev={}){
      if(type === "acabado"){
        return Object.assign({
          acabado: "", alce: "", cantidad: "", empacado: "",
          final: { cajas: false, diurex:false, pegamento:false, especiales:false },
          observaciones: ""
        }, prev);
      }
      if(type === "suaje"){
        return Object.assign({
          suajista: "", original: "", trazo: "",
          sacabocado: "", perforado: "", figura: "", replecado: "",
          observaciones: ""
        }, prev);
      }
      if(type === "impresion"){
        return Object.assign({
          prensista: "", tiro: "", frenteVuelta: "",
          placas: "", tintas: "", barniz: "", tEspeciales: "",
          observaciones: ""
        }, prev);
      }
      if(type === "maquina_suaje"){
        return Object.assign({
          prensista: "", tiro: "", arreglos: "", folioInterno: "",
          observaciones: ""
        }, prev);
      }
      return prev;
    }

    function baseFieldsHTML(){
      return `
        <div class="formGrid">
          ${field("numero", "Número")}
          ${field("fecha", "Fecha", "date")}
          ${field("trabajo", "Trabajo")}
          ${field("cliente", "Cliente")}
        </div>
      `;
    }

    function field(key, label, type="text", placeholder=""){
      const value = state.order[key] ?? "";
      return `
        <div>
          <div class="label">${label}</div>
          <input class="input" type="${type}" placeholder="${placeholder}" value="${escapeHtml(value)}"
            data-bind="order.${key}" />
        </div>
      `;
    }

    function subField(key, label, type="text", placeholder=""){
      const value = state.order.data[key] ?? "";
      return `
        <div>
          <div class="label">${label}</div>
          <input class="input" type="${type}" placeholder="${placeholder}" value="${escapeHtml(value)}"
            data-bind="data.${key}" />
        </div>
      `;
    }

    function subTextArea(key, label, placeholder=""){
      const value = state.order.data[key] ?? "";
      return `
        <div>
          <div class="label">${label}</div>
          <textarea class="input" rows="4" placeholder="${placeholder}" data-bind="data.${key}">${escapeHtml(value)}</textarea>
        </div>
      `;
    }

    function escapeHtml(str){
      return String(str ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function check(key, label){
      return `
        <label class="check">
          <input type="checkbox" data-check="${key}">
          <span>${label}</span>
        </label>
      `;
    }

    function renderForm(){
      const area = $("#formArea");

      if(!state.jobType){
        area.innerHTML = `<div class="hint">Selecciona un tipo de trabajo para mostrar el formato.</div>`;
        return;
      }

      let html = baseFieldsHTML();

      if(state.jobType === "acabado"){
        html += `
          <div class="sectionTitle">Acabado</div>
          <div class="formGrid">
            ${subField("acabado", "Acabado")}
            ${subField("alce", "Alce")}
            ${subField("cantidad", "Cantidad")}
            ${subField("empacado", "Empacado")}
          </div>

          <div class="divider"></div>
          <div class="sectionTitle">Acabado final</div>
          <div class="checks">
            ${check("final.cajas", "Cajas o Craft")}
            ${check("final.diurex", "Diurex")}
            ${check("final.pegamento", "Pegamento")}
            ${check("final.especiales", "Especiales")}
          </div>

          <div class="divider"></div>
          ${subTextArea("observaciones", "Observaciones")}
        `;
      }

      if(state.jobType === "suaje"){
        html += `
          <div class="sectionTitle">Suaje</div>
          <div class="formGrid">
            ${subField("suajista", "Suajista")}
            ${subField("original", "Original")}
            ${subField("trazo", "Trazo o Dibujo")}
            <div></div>
          </div>

          <div class="divider"></div>
          <div class="sectionTitle">Detalle</div>
          <div class="formGrid">
            ${subField("sacabocado", "Sacabocado")}
            ${subField("perforado", "Perforado")}
            ${subField("figura", "Figura")}
            ${subField("replecado", "Replecado")}
          </div>

          <div class="divider"></div>
          ${subTextArea("observaciones", "Observaciones")}
        `;
      }

      if(state.jobType === "impresion"){
        html += `
          <div class="sectionTitle">Impresión</div>
          <div class="formGrid">
            ${subField("prensista", "Prensista")}
            ${subField("tiro", "Tiro")}
            ${subField("frenteVuelta", "Fte. / Vta.", "text", "Frente / Vuelta")}
            <div></div>
          </div>

          <div class="divider"></div>
          <div class="sectionTitle">Material / Tintas</div>
          <div class="formGrid">
            ${subField("placas", "Placas")}
            ${subField("tintas", "Tintas")}
            ${subField("barniz", "Barniz")}
            ${subField("tEspeciales", "T. Especiales")}
          </div>

          <div class="divider"></div>
          ${subTextArea("observaciones", "Observaciones")}
        `;
      }

      if(state.jobType === "maquina_suaje"){
        html += `
          <div class="sectionTitle">Máquina de suaje</div>
          <div class="formGrid">
            ${subField("prensista", "Prensista")}
            ${subField("tiro", "Tiro")}
            ${subField("arreglos", "Arreglos")}
            ${subField("folioInterno", "Folio (interno)")}
          </div>

          <div class="divider"></div>
          ${subTextArea("observaciones", "Observaciones")}
        `;
      }

      area.innerHTML = html;

      // bind inputs
      area.querySelectorAll("[data-bind]").forEach(el=>{
        el.addEventListener("input", ()=>{
          const path = el.getAttribute("data-bind");
          const val = el.value;

          if(path.startsWith("order.")){
            const k = path.split(".")[1];
            state.order[k] = val;
          }else if(path.startsWith("data.")){
            const k = path.split(".")[1];
            state.order.data[k] = val;
          }
          $("#orderPill").textContent = `Folio: ${state.order.folio}`;
          renderSession();
        });
      });

      // bind checks
      area.querySelectorAll("input[type='checkbox'][data-check]").forEach(el=>{
        el.addEventListener("change", ()=>{
          const key = el.getAttribute("data-check");
          const [a,b] = key.split(".");
          state.order.data[a][b] = el.checked;
        });
      });

      // initial checks
      area.querySelectorAll("input[type='checkbox'][data-check]").forEach(el=>{
        const key = el.getAttribute("data-check");
        const [a,b] = key.split(".");
        el.checked = !!(state.order.data?.[a]?.[b]);
      });
    }

    function renderHistory(){
      const list = $("#historyList");
      const all = loadAll().sort((a,b)=> (b.createdAt||"").localeCompare(a.createdAt||""));
      $("#historyCount").textContent = `${all.length}`;
      list.innerHTML = "";

      all.slice(0, 40).forEach(o=>{
        const div = document.createElement("div");
        div.className = "row";
        div.innerHTML = `
          <div class="left">
            <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
              <span class="tag">${o.jobTypeTitle}</span>
              <span style="font-weight:650; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; max-width: 260px;">
                ${o.trabajo || "—"}
              </span>
            </div>
            <div style="color:var(--muted); font-size:12px;">
              Cliente: ${o.cliente || "—"} • Empleado: ${o.employee?.name || "—"}
            </div>
          </div>
          <div class="right">
            ${o.folio}<br/>
            ${(o.fecha || "").toString()}
          </div>
        `;
        div.onclick = () => {
          state.employee = o.employee || null;
          state.jobType = o.jobTypeKey || null;
          state.order = {
            folio: o.folio,
            createdAt: o.createdAt,
            numero: o.numero || "",
            fecha: o.fecha || "",
            trabajo: o.trabajo || "",
            cliente: o.cliente || "",
            data: o.data || {}
          };
          $("#orderPill").textContent = `Folio: ${state.order.folio}`;
          renderEmployees($("#employeeSearch").value);
          renderJobTypes();
          renderForm();
          renderSession();
        };
        list.appendChild(div);
      });

      if(all.length === 0){
        list.innerHTML = `<div class="hint">Aún no hay órdenes guardadas.</div>`;
      }
    }

    function validate(){
      if(!state.employee) return "Selecciona un empleado.";
      if(!state.jobType) return "Selecciona un tipo de trabajo.";
      if(!state.order.trabajo.trim()) return "Escribe el trabajo.";
      return null;
    }

    function saveOrder(){
      const err = validate();
      if(err){ alert(err); return; }

      const job = JOB_TYPES.find(j=>j.key===state.jobType);
      const all = loadAll();

      const payload = {
        employee: state.employee,
        jobTypeKey: state.jobType,
        jobTypeTitle: job?.title || state.jobType,
        folio: state.order.folio || uid(),
        createdAt: state.order.createdAt || new Date().toISOString(),
        numero: state.order.numero,
        fecha: state.order.fecha,
        trabajo: state.order.trabajo,
        cliente: state.order.cliente,
        data: state.order.data
      };

      const idx = all.findIndex(x=>x.folio===payload.folio);
      if(idx >= 0) all[idx] = payload;
      else all.push(payload);

      saveAll(all);
      renderHistory();
      alert("Orden guardada ✅");
    }

    function buildPrint(){
      const job = JOB_TYPES.find(j=>j.key===state.jobType);
      document.getElementById("pTitle").textContent = `Orden de Trabajo • ${job?.title || "—"}`;

      const meta = [
        `Folio: ${state.order.folio}`,
        `Fecha: ${state.order.fecha || "—"}`,
        `Empleado: ${state.employee ? `${state.employee.name} (${state.employee.id})` : "—"}`
      ].join(" • ");
      document.getElementById("pMeta").textContent = meta;

      const grid = document.getElementById("pGrid");
      grid.innerHTML = "";

      const pairs = [];
      pairs.push(["Número", state.order.numero || "—"]);
      pairs.push(["Trabajo", state.order.trabajo || "—"]);
      pairs.push(["Cliente", state.order.cliente || "—"]);

      const d = state.order.data || {};
      if(state.jobType==="acabado"){
        pairs.push(["Acabado", d.acabado || "—"]);
        pairs.push(["Alce", d.alce || "—"]);
        pairs.push(["Cantidad", d.cantidad || "—"]);
        pairs.push(["Empacado", d.empacado || "—"]);
        pairs.push(["Final", [
          d.final?.cajas ? "Cajas/Craft" : null,
          d.final?.diurex ? "Diurex" : null,
          d.final?.pegamento ? "Pegamento" : null,
          d.final?.especiales ? "Especiales" : null,
        ].filter(Boolean).join(", ") || "—"]);
      }
      if(state.jobType==="suaje"){
        pairs.push(["Suajista", d.suajista || "—"]);
        pairs.push(["Original", d.original || "—"]);
        pairs.push(["Trazo/Dibujo", d.trazo || "—"]);
        pairs.push(["Sacabocado", d.sacabocado || "—"]);
        pairs.push(["Perforado", d.perforado || "—"]);
        pairs.push(["Figura", d.figura || "—"]);
        pairs.push(["Replecado", d.replecado || "—"]);
      }
      if(state.jobType==="impresion"){
        pairs.push(["Prensista", d.prensista || "—"]);
        pairs.push(["Tiro", d.tiro || "—"]);
        pairs.push(["Fte/Vta", d.frenteVuelta || "—"]);
        pairs.push(["Placas", d.placas || "—"]);
        pairs.push(["Tintas", d.tintas || "—"]);
        pairs.push(["Barniz", d.barniz || "—"]);
        pairs.push(["T. Especiales", d.tEspeciales || "—"]);
      }
      if(state.jobType==="maquina_suaje"){
        pairs.push(["Prensista", d.prensista || "—"]);
        pairs.push(["Tiro", d.tiro || "—"]);
        pairs.push(["Arreglos", d.arreglos || "—"]);
        pairs.push(["Folio interno", d.folioInterno || "—"]);
      }

      pairs.forEach(([k,v])=>{
        const el = document.createElement("div");
        el.className = "printLine";
        el.innerHTML = `<b>${escapeHtml(k)}:</b> ${escapeHtml(v)}`;
        grid.appendChild(el);
      });

      document.getElementById("pNotes").innerHTML =
        `<div class="printLine"><b>Observaciones:</b> ${escapeHtml(d.observaciones || "—")}</div>`;
    }

    document.getElementById("employeeSearch").addEventListener("input", (e)=> renderEmployees(e.target.value));
    document.getElementById("btnSave").addEventListener("click", saveOrder);
    document.getElementById("btnNew").addEventListener("click", ()=> { resetOrder(); alert("Listo. Nueva orden ✅"); });
    document.getElementById("btnClear").addEventListener("click", ()=>{
      const ok = confirm("¿Seguro que quieres borrar TODO el historial de esta compu?");
      if(!ok) return;
      saveAll([]);
      renderHistory();
      alert("Historial borrado.");
    });
    document.getElementById("btnPrint").addEventListener("click", ()=>{
      const err = validate();
      if(err){ alert(err); return; }
      buildPrint();
      window.print();
    });

    function init(){
      state.employee = null;
      resetOrder();
      renderEmployees("");
      renderHistory();
      renderSession();
      document.getElementById("orderPill").textContent = `Folio: ${state.order.folio}`;
    }
    init();
  </script>
</body>
</html>
