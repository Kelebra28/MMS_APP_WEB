<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Órdenes de Trabajo • Taller</title>
  <style>
    :root{
      --bg:#0b0b0d;
      --text:#f2f2f3;
      --muted:#a7a7ad;
      --line:#24242c;
      --radius:16px;
      --shadow: 0 10px 30px rgba(0,0,0,.45);
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:var(--sans);
      color:var(--text);
      background: radial-gradient(1200px 700px at 20% 0%, #141420 0%, var(--bg) 55%, #070708 100%);
      min-height:100vh;
    }
    .app{ max-width:1100px; margin:0 auto; padding:28px 18px 60px; }

    .topbar{
      display:flex; gap:14px; align-items:center; justify-content:space-between;
      padding:16px 18px;
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      position:sticky; top:12px; backdrop-filter: blur(10px); z-index:20;
    }
    .brand{ display:flex; align-items:center; gap:12px; min-width: 220px; }
    .logo{
      width:42px; height:42px; border-radius:14px;
      background: linear-gradient(135deg, rgba(255,255,255,.9), rgba(255,255,255,.25));
      box-shadow: 0 10px 25px rgba(255,255,255,.08);
      flex: 0 0 auto;
    }
    .brand h1{ font-size:14px; margin:0; letter-spacing:.4px; font-weight:650; }
    .brand p{ margin:2px 0 0; font-size:12px; color:var(--muted); }

    .actions{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:flex-end; }
    .btn{
      appearance:none;
      border:1px solid var(--line);
      background:rgba(255,255,255,.04);
      color:var(--text);
      padding:10px 12px;
      border-radius:14px;
      cursor:pointer;
      font-weight:600;
      letter-spacing:.2px;
      transition:.15s ease;
      display:inline-flex; align-items:center; justify-content:center; gap:8px;
      min-height: 40px;
    }
    .btn:hover{ transform: translateY(-1px); background:rgba(255,255,255,.06); }
    .btn.primary{ background:rgba(255,255,255,.92); color:#0b0b0d; border-color:transparent; }
    .btn.primary:hover{ background:#fff; }
    .btn.danger{ background: rgba(255, 124, 124, .14); border-color: rgba(255, 124, 124, .35); }
    .btn.ghost{ background: rgba(0,0,0,.18); }
    .pill{
      font-family:var(--mono);
      font-size:11px;
      color:var(--muted);
      border:1px solid var(--line);
      padding:8px 10px;
      border-radius:999px;
      background:rgba(0,0,0,.25);
      white-space:nowrap;
    }

    .grid{
      display:grid;
      grid-template-columns: 360px 1fr;
      gap:14px;
      margin-top:16px;
    }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
      min-width: 0;
    }
    .card .head{
      padding:14px 16px;
      border-bottom:1px solid var(--line);
      display:flex; justify-content:space-between; align-items:center;
      gap:12px;
    }
    .card .head h2{
      margin:0;
      font-size:13px;
      letter-spacing:.4px;
      text-transform:uppercase;
      color:rgba(255,255,255,.92);
    }
    .card .body{ padding:14px 16px 18px; }

    .step{ display:flex; gap:10px; align-items:center; color:var(--muted); font-size:12px; margin-bottom:12px; }
    .step b{ color:var(--text); }

    .input, textarea{
      width:100%;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.28);
      color:var(--text);
      outline:none;
      transition:.15s ease;
      min-height: 44px;
    }
    textarea{ min-height:110px; resize:vertical; }
    .input:focus, textarea:focus{
      border-color: rgba(255,255,255,.25);
      box-shadow: 0 0 0 4px rgba(255,255,255,.06);
    }

    .label{ font-size:12px; color:var(--muted); margin:12px 0 6px; display:flex; justify-content:space-between; gap:8px; }
    .divider{ height:1px; background: var(--line); margin:12px 0; }

    .list{ display:flex; flex-direction:column; gap:8px; margin-top:10px; max-height: 380px; overflow:auto; padding-right: 6px; }
    .item{
      padding:10px 12px;
      border:1px solid var(--line);
      border-radius:14px;
      background: rgba(255,255,255,.03);
      cursor:pointer;
      transition:.15s ease;
      display:flex; align-items:center; justify-content:space-between;
      gap:10px;
    }
    .item:hover{ background: rgba(255,255,255,.05); transform: translateY(-1px); }
    .item .name{ font-weight:650; font-size:13px; }
    .item .meta{ font-family:var(--mono); font-size:11px; color:var(--muted); }
    .item.selected{
      border-color: rgba(255,255,255,.35);
      box-shadow: 0 0 0 4px rgba(255,255,255,.06);
      background: rgba(255,255,255,.06);
    }

    .jobTypes{ display:grid; grid-template-columns: repeat(4, minmax(0, 1fr)); gap:10px; }
    .jobCard{
      border:1px solid var(--line);
      border-radius:16px;
      padding:12px;
      background: rgba(0,0,0,.22);
      cursor:pointer;
      transition:.15s ease;
      min-width: 0;
    }
    .jobCard:hover{ transform: translateY(-1px); background: rgba(255,255,255,.04); }
    .jobCard.active{
      border-color: rgba(255,255,255,.35);
      box-shadow: 0 0 0 4px rgba(255,255,255,.06);
    }
    .jobCard h3{ margin:0; font-size:13px; letter-spacing:.3px; }
    .jobCard p{ margin:6px 0 0; font-size:12px; color:var(--muted); }

    .formGrid{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    .sectionTitle{ margin:14px 0 6px; font-size:12px; color:rgba(255,255,255,.9); text-transform:uppercase; letter-spacing:.35px; }

    .checks{ display:grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap:8px; margin-top:8px; }
    .check{
      display:flex; gap:10px; align-items:center;
      border:1px solid var(--line);
      border-radius:14px;
      padding:10px 12px;
      background: rgba(255,255,255,.03);
      min-height:44px;
    }
    .check input{ transform: scale(1.15); }

    .history{ display:flex; flex-direction:column; gap:8px; max-height: 360px; overflow:auto; padding-right: 6px; }
    .row{
      display:flex; gap:10px; justify-content:space-between; align-items:flex-start;
      border:1px solid var(--line);
      border-radius:14px;
      padding:10px 12px;
      background: rgba(255,255,255,.03);
      cursor:pointer;
      transition:.15s ease;
    }
    .row:hover{ background: rgba(255,255,255,.05); transform: translateY(-1px); }
    .row.active{
      border-color: rgba(255,255,255,.35);
      box-shadow: 0 0 0 4px rgba(255,255,255,.06);
    }
    .row .left{ display:flex; flex-direction:column; gap:4px; min-width:0; }
    .row .right{ text-align:right; font-family:var(--mono); font-size:11px; color:var(--muted); }
    .tag{
      display:inline-flex;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.22);
      font-size:11px;
      color: var(--muted);
      width: fit-content;
      flex: 0 0 auto;
    }

    .hint{ font-size:12px; color:var(--muted); line-height:1.45; margin-top:10px; }

    /* Modal */
    .modalOverlay{
      position:fixed; inset:0;
      background: rgba(0,0,0,.55);
      display:none;
      align-items:center; justify-content:center;
      padding:16px;
      z-index:999;
    }
    .modalOverlay.show{ display:flex; }
    .modal{
      width:min(520px, 100%);
      border-radius:18px;
      border:1px solid var(--line);
      background: linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.03));
      box-shadow: 0 20px 70px rgba(0,0,0,.65);
      overflow:hidden;
    }
    .modalHead{
      padding:14px 16px;
      border-bottom:1px solid var(--line);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .modalHead h3{ margin:0; font-size:13px; text-transform:uppercase; letter-spacing:.35px; }
    .modalBody{ padding:14px 16px; color: rgba(255,255,255,.92); }
    .modalFoot{
      padding:14px 16px;
      border-top:1px solid var(--line);
      display:flex; gap:10px; justify-content:flex-end; flex-wrap:wrap;
    }

    /* Responsive */
    @media (max-width: 980px){
      .app{ padding:18px 14px 44px; }
      .grid{ grid-template-columns: 1fr; }
      .topbar{ position:relative; top:auto; }
      .jobTypes{ grid-template-columns: repeat(2, minmax(0, 1fr)); }
      .brand{ min-width: 0; }
    }
    @media (min-width: 768px) and (max-width: 1024px) and (orientation: landscape){
      .grid{ grid-template-columns: 330px 1fr; }
      .jobTypes{ grid-template-columns: repeat(4, minmax(0, 1fr)); }
      .list{ max-height: 320px; }
      .history{ max-height: 300px; }
    }
    @media (max-width: 560px){
      .topbar{ flex-direction:column; align-items:stretch; gap:12px; }
      .actions{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; justify-content:stretch; }
      #sessionPill{ grid-column: 1 / -1; text-align:center; }
      .jobTypes{ grid-template-columns: 1fr; }
      .formGrid{ grid-template-columns: 1fr; }
      .checks{ grid-template-columns: 1fr; }
      .list{ max-height: 260px; }
      .history{ max-height: 240px; }
      .btn{ width:100%; }
    }

    @media print{
      body{ background:#fff; }
      .topbar, .grid, .modalOverlay{ display:none !important; }
      .printArea{ display:block !important; color:#000; padding:0; max-width: 800px; margin: 0 auto; }
      .printCard{ border:1px solid #000; padding:14px; border-radius:0; box-shadow:none; background:#fff; }
      .printCard h2{ margin:0 0 10px; }
      .printGrid{ display:grid; grid-template-columns: 1fr 1fr; gap:8px; }
      .printLine{ border-bottom:1px solid #000; padding:6px 0; }
      .printSmall{ font-size:12px; }
    }

    .printArea{ display:none; }
  </style>
</head>

<body>
  <div class="app">
    <div class="topbar">
      <div class="brand">
        <div class="logo"></div>
        <div>
          <h1>Órdenes de Trabajo • Taller</h1>
          <p>Negro elegante • rápido • sin confusión</p>
        </div>
      </div>

      <div class="actions">
        <span class="pill" id="sessionPill">Empleado: — • Vista: —</span>
        <button class="btn" id="btnNew">Nuevo</button>
        <button class="btn" id="btnPrint">Imprimir</button>
        <button class="btn danger" id="btnClear">Borrar historial</button>
        <button class="btn primary" id="btnSave">Guardar orden</button>
      </div>
    </div>

    <div class="grid">
      <!-- LEFT -->
      <div class="card">
        <div class="head">
          <h2 id="leftTitle">Empleado</h2>
          <span class="pill" id="employeeCount">—</span>
        </div>

        <div class="body">
          <!-- Employee chooser -->
          <div id="employeeChooser">
            <div class="step"><b>1)</b> Busca y selecciona al trabajador</div>
            <input class="input" id="employeeSearch" placeholder="Buscar: empleado 1, empleado 2..." />
            <div class="list" id="employeeList"></div>
          </div>

          <!-- Employee locked -->
          <div id="employeeLocked" style="display:none;">
            <div class="step"><b>1)</b> Empleado activo</div>
            <div class="item selected" id="selectedEmployeeCard" style="cursor:default;">
              <div>
                <div class="name" id="selName">—</div>
                <div class="meta" id="selId">—</div>
              </div>
              <div class="tag">ACTIVO</div>
            </div>
            <div style="display:flex; gap:10px; margin-top:10px; flex-wrap:wrap;">
              <button class="btn ghost" id="btnChangeEmployee">Cambiar empleado</button>
              <button class="btn danger" id="btnClearEmployee">Quitar selección</button>
            </div>
          </div>

          <div class="divider"></div>

          <div class="head" style="padding:0 0 10px; border:0;">
            <h2 style="margin:0;">Historial</h2>
            <span class="pill" id="historyCount">—</span>
          </div>
          <div class="history" id="historyList"></div>

          <p class="hint">Tip: toca un registro para verlo en grande a la derecha (y reimprimir / editar).</p>
        </div>
      </div>

      <!-- RIGHT -->
      <div class="card">
        <div class="head">
          <h2 id="rightTitle">Orden</h2>
          <span class="pill" id="orderPill">Folio: —</span>
        </div>
        <div class="body" id="rightBody"></div>
      </div>
    </div>

    <!-- PRINT -->
    <div class="printArea" id="printArea">
      <div class="printCard">
        <h2 id="pTitle">Orden de Trabajo</h2>
        <div class="printSmall" id="pMeta"></div>
        <div style="height:10px"></div>
        <div class="printGrid" id="pGrid"></div>
        <div style="height:10px"></div>
        <div id="pNotes"></div>
      </div>
    </div>
  </div>

  <!-- MODAL -->
  <div class="modalOverlay" id="modalOverlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <div class="modalHead">
        <h3 id="modalTitle">Mensaje</h3>
        <button class="btn ghost" id="modalClose">Cerrar</button>
      </div>
      <div class="modalBody" id="modalBody">—</div>
      <div class="modalFoot" id="modalFoot">
        <button class="btn ghost" id="modalCancel">Cancelar</button>
        <button class="btn primary" id="modalOk">OK</button>
      </div>
    </div>
  </div>

  <script>
    // ============
    // CONFIG
    // ============
    const EMPLOYEES = [
      { id: "E01", name: "Empleado 1" },
      { id: "E02", name: "Empleado 2" },
      { id: "E03", name: "Empleado 3" },
      { id: "E04", name: "Empleado 4" },
      { id: "E05", name: "Empleado 5" },
    ];

    const JOB_TYPES = [
      { key: "acabado", title: "Acabado", desc: "Acabado + Alce + Cantidad + Empacado + Acabado final" },
      { key: "suaje", title: "Suaje", desc: "Suajista + Original + Trazo/Dibujo + Sacabocado/Perforado..." },
      { key: "impresion", title: "Impresión", desc: "Prensista + Tiro + Frente/Vuelta + Placas/Tintas/Barniz" },
      { key: "maquina_suaje", title: "Máquina de suaje", desc: "Formato rápido: Tiro + Arreglos + Folio + Observaciones" }
    ];

    const LS_KEY = "taller_orders_v2";

    // ============
    // STATE
    // view: "edit" | "detail"
    // ============
    let state = {
      employee: null,
      jobType: null,
      view: "edit",
      selectedHistoryFolio: null,
      order: {
        folio: null,
        createdAt: null,
        numero: null,
        fecha: "",
        trabajo: "",
        cliente: "",
        data: {}
      }
    };

    const $ = (sel) => document.querySelector(sel);

    // ============
    // MODAL (no alerts)
    // ============
    let modalResolve = null;

    function showModal({ title="Mensaje", message="—", okText="OK", cancelText=null, danger=false }){
      $("#modalTitle").textContent = title;
      $("#modalBody").innerHTML = message;

      $("#modalOk").textContent = okText;
      $("#modalOk").className = "btn " + (danger ? "danger" : "primary");

      if(cancelText){
        $("#modalCancel").style.display = "inline-flex";
        $("#modalCancel").textContent = cancelText;
      }else{
        $("#modalCancel").style.display = "none";
      }

      $("#modalOverlay").classList.add("show");
      $("#modalOverlay").setAttribute("aria-hidden","false");

      return new Promise((resolve)=>{
        modalResolve = resolve;
      });
    }

    function closeModal(result){
      $("#modalOverlay").classList.remove("show");
      $("#modalOverlay").setAttribute("aria-hidden","true");
      if(modalResolve){ modalResolve(result); modalResolve = null; }
    }

    $("#modalClose").onclick = () => closeModal(false);
    $("#modalCancel").onclick = () => closeModal(false);
    $("#modalOk").onclick = () => closeModal(true);
    $("#modalOverlay").addEventListener("click", (e)=>{
      if(e.target.id === "modalOverlay") closeModal(false);
    });

    // ============
    // STORAGE
    // ============
    function loadAll(){
      try{ return JSON.parse(localStorage.getItem(LS_KEY) || "[]"); }
      catch{ return []; }
    }
    function saveAll(list){ localStorage.setItem(LS_KEY, JSON.stringify(list)); }

    // ============
    // HELPERS
    // ============
    function uid(){
      const d = new Date();
      const pad = (n)=> String(n).padStart(2,"0");
      return `OT-${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}-${pad(d.getHours())}${pad(d.getMinutes())}${pad(d.getSeconds())}`;
    }

    function escapeHtml(str){
      return String(str ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function setSessionPill(){
      const emp = state.employee ? `${state.employee.name} (${state.employee.id})` : "—";
      const view = state.view === "detail" ? "Detalle" : "Edición";
      $("#sessionPill").textContent = `Empleado: ${emp} • Vista: ${view}`;
    }

    function buildDefaultData(type, prev={}){
      if(type === "acabado"){
        return Object.assign({
          acabado: "", alce: "", cantidad: null, empacado: "",
          final: { cajas: false, diurex:false, pegamento:false, especiales:false },
          observaciones: ""
        }, prev);
      }
      if(type === "suaje"){
        return Object.assign({
          suajista: "", original: "", trazo: "",
          sacabocado: "", perforado: "", figura: "", replecado: "",
          observaciones: ""
        }, prev);
      }
      if(type === "impresion"){
        return Object.assign({
          prensista: "", tiro: null, frenteVuelta: "",
          placas: null, tintas: null, barniz: "", tEspeciales: "",
          observaciones: ""
        }, prev);
      }
      if(type === "maquina_suaje"){
        return Object.assign({
          prensista: "", tiro: null, arreglos: "", folioInterno: "",
          observaciones: ""
        }, prev);
      }
      return prev;
    }

    // ============
    // EMPLOYEE LOCK UI
    // ============
    function lockEmployeeUI(){
      $("#employeeChooser").style.display = "none";
      $("#employeeLocked").style.display = "block";
      $("#leftTitle").textContent = "Empleado (bloqueado)";
      $("#selName").textContent = state.employee?.name || "—";
      $("#selId").textContent = state.employee?.id || "—";
    }

    function unlockEmployeeUI(){
      $("#employeeChooser").style.display = "block";
      $("#employeeLocked").style.display = "none";
      $("#leftTitle").textContent = "Empleado";
    }

    $("#btnChangeEmployee").onclick = () => {
      // solo desbloquea para elegir otro (sin borrar historial)
      unlockEmployeeUI();
      renderEmployees($("#employeeSearch").value);
    };

    $("#btnClearEmployee").onclick = async () => {
      const ok = await showModal({
        title: "Quitar empleado",
        message: "¿Quieres quitar la selección de empleado? (Se mantiene el historial guardado, solo regresas a escoger.)",
        okText: "Sí, quitar",
        cancelText: "Cancelar",
        danger: true
      });
      if(!ok) return;
      state.employee = null;
      state.selectedHistoryFolio = null;
      unlockEmployeeUI();
      renderEmployees("");
      renderHistory();
      setSessionPill();
      renderRight();
    };

    // ============
    // EMPLOYEES
    // ============
    function renderEmployees(filter=""){
      const list = $("#employeeList");
      const f = filter.trim().toLowerCase();
      const items = EMPLOYEES.filter(e => e.name.toLowerCase().includes(f) || e.id.toLowerCase().includes(f));

      $("#employeeCount").textContent = `${items.length} / ${EMPLOYEES.length}`;
      list.innerHTML = "";

      items.forEach(emp=>{
        const div = document.createElement("div");
        const isSel = state.employee?.id === emp.id;
        div.className = "item" + (isSel ? " selected" : "");
        div.innerHTML = `
          <div>
            <div class="name">${emp.name}</div>
            <div class="meta">${emp.id}</div>
          </div>
          <div class="tag">${isSel ? "SELECCIONADO" : "ELEGIR"}</div>
        `;
        div.onclick = () => {
          state.employee = emp;
          lockEmployeeUI();
          state.selectedHistoryFolio = null;
          setSessionPill();
          renderHistory();  // filtrado por empleado
          renderRight();    // si estaba en detalle, lo resetea
        };
        list.appendChild(div);
      });
    }

    $("#employeeSearch").addEventListener("input", (e)=> renderEmployees(e.target.value));

    // ============
    // HISTORY (filtered by employee)
    // ============
    function getFilteredHistory(){
      const all = loadAll().sort((a,b)=> (b.createdAt||"").localeCompare(a.createdAt||""));
      if(!state.employee) return all;
      return all.filter(o => o.employee?.id === state.employee.id);
    }

    function renderHistory(){
      const list = $("#historyList");
      const filtered = getFilteredHistory();
      $("#historyCount").textContent = `${filtered.length}`;

      list.innerHTML = "";

      if(!state.employee){
        list.innerHTML = `<div class="hint">Primero selecciona un empleado para ver su historial (evita confusiones).</div>`;
        return;
      }

      if(filtered.length === 0){
        list.innerHTML = `<div class="hint">Este empleado aún no tiene órdenes guardadas.</div>`;
        return;
      }

      filtered.slice(0, 60).forEach(o=>{
        const div = document.createElement("div");
        div.className = "row" + (state.selectedHistoryFolio === o.folio ? " active" : "");
        div.innerHTML = `
          <div class="left">
            <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
              <span class="tag">${o.jobTypeTitle}</span>
              <span style="font-weight:650; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; max-width: 250px;">
                ${o.trabajo || "—"}
              </span>
            </div>
            <div style="color:var(--muted); font-size:12px;">
              Cliente: ${o.cliente || "—"}
            </div>
          </div>
          <div class="right">
            ${o.folio}<br/>
            ${(o.fecha || "").toString()}
          </div>
        `;
        div.onclick = () => {
          state.view = "detail";
          state.selectedHistoryFolio = o.folio;
          setSessionPill();
          renderHistory();
          renderRightDetail(o);
        };
        list.appendChild(div);
      });
    }

    // ============
    // RIGHT PANEL
    // ============
    function resetOrder(){
      state.view = "edit";
      state.selectedHistoryFolio = null;
      state.jobType = null;
      state.order = {
        folio: uid(),
        createdAt: new Date().toISOString(),
        numero: null,
        fecha: new Date().toISOString().slice(0,10),
        trabajo: "",
        cliente: "",
        data: {}
      };
      $("#orderPill").textContent = `Folio: ${state.order.folio}`;
      setSessionPill();
      renderRight();
      renderHistory();
    }

    function renderRight(){
      $("#rightTitle").textContent = "Orden";
      const body = $("#rightBody");

      if(!state.employee){
        body.innerHTML = `
          <div class="step"><b>2)</b> Selecciona empleado</div>
          <div class="hint">Por seguridad y para evitar errores, primero se elige empleado. Después se trabaja todo sobre ese empleado.</div>
        `;
        return;
      }

      // modo edición
      state.view = "edit";
      setSessionPill();

      body.innerHTML = `
        <div class="step"><b>2)</b> Elige el tipo de trabajo</div>
        <div class="jobTypes" id="jobTypes"></div>

        <div class="divider"></div>

        <div class="step"><b>3)</b> Llena el formato</div>
        <div id="formArea"></div>

        <p class="hint">Tip: el historial de la izquierda es SOLO de <b>${escapeHtml(state.employee.name)}</b>.</p>
      `;

      renderJobTypes();
      renderForm();
    }

    function renderJobTypes(){
      const wrap = $("#jobTypes");
      wrap.innerHTML = "";
      JOB_TYPES.forEach(j=>{
        const div = document.createElement("div");
        div.className = "jobCard" + (state.jobType===j.key ? " active" : "");
        div.innerHTML = `<h3>${j.title}</h3><p>${j.desc}</p>`;
        div.onclick = () => {
          state.jobType = j.key;
          state.order.data = buildDefaultData(j.key, state.order.data);
          $("#orderPill").textContent = `Folio: ${state.order.folio}`;
          renderJobTypes();
          renderForm();
        };
        wrap.appendChild(div);
      });
    }

    function renderRightDetail(orderObj){
      $("#rightTitle").textContent = "Detalle del historial";
      $("#orderPill").textContent = `Folio: ${orderObj.folio}`;

      const d = orderObj.data || {};
      const pairs = [];
      pairs.push(["Tipo", orderObj.jobTypeTitle]);
      pairs.push(["Fecha", orderObj.fecha || "—"]);
      pairs.push(["Número", orderObj.numero ?? "—"]);
      pairs.push(["Trabajo", orderObj.trabajo || "—"]);
      pairs.push(["Cliente", orderObj.cliente || "—"]);

      if(orderObj.jobTypeKey === "acabado"){
        pairs.push(["Acabado", d.acabado || "—"]);
        pairs.push(["Alce", d.alce || "—"]);
        pairs.push(["Cantidad", d.cantidad ?? "—"]);
        pairs.push(["Empacado", d.empacado || "—"]);
        pairs.push(["Acabado final", [
          d.final?.cajas ? "Cajas/Craft" : null,
          d.final?.diurex ? "Diurex" : null,
          d.final?.pegamento ? "Pegamento" : null,
          d.final?.especiales ? "Especiales" : null,
        ].filter(Boolean).join(", ") || "—"]);
      }
      if(orderObj.jobTypeKey === "suaje"){
        pairs.push(["Suajista", d.suajista || "—"]);
        pairs.push(["Original", d.original || "—"]);
        pairs.push(["Trazo/Dibujo", d.trazo || "—"]);
        pairs.push(["Sacabocado", d.sacabocado || "—"]);
        pairs.push(["Perforado", d.perforado || "—"]);
        pairs.push(["Figura", d.figura || "—"]);
        pairs.push(["Replecado", d.replecado || "—"]);
      }
      if(orderObj.jobTypeKey === "impresion"){
        pairs.push(["Prensista", d.prensista || "—"]);
        pairs.push(["Tiro", d.tiro ?? "—"]);
        pairs.push(["Fte/Vta", d.frenteVuelta || "—"]);
        pairs.push(["Placas", d.placas ?? "—"]);
        pairs.push(["Tintas", d.tintas ?? "—"]);
        pairs.push(["Barniz", d.barniz || "—"]);
        pairs.push(["T. Especiales", d.tEspeciales || "—"]);
      }
      if(orderObj.jobTypeKey === "maquina_suaje"){
        pairs.push(["Prensista", d.prensista || "—"]);
        pairs.push(["Tiro", d.tiro ?? "—"]);
        pairs.push(["Arreglos", d.arreglos || "—"]);
        pairs.push(["Folio interno", d.folioInterno || "—"]);
      }

      const htmlPairs = pairs.map(([k,v]) => `
        <div style="border:1px solid var(--line); border-radius:14px; padding:10px 12px; background: rgba(255,255,255,.03);">
          <div style="font-size:11px; color: var(--muted); text-transform:uppercase; letter-spacing:.35px;">${escapeHtml(k)}</div>
          <div style="margin-top:4px; font-weight:650;">${escapeHtml(v)}</div>
        </div>
      `).join("");

      $("#rightBody").innerHTML = `
        <div class="step"><b>Vista</b> grande del registro</div>

        <div style="display:flex; gap:10px; flex-wrap:wrap; margin-bottom:12px;">
          <button class="btn" id="btnBackToEdit">Volver a edición</button>
          <button class="btn primary" id="btnEditThis">Editar este</button>
          <button class="btn" id="btnPrintThis">Imprimir</button>
          <button class="btn danger" id="btnDeleteThis">Eliminar</button>
        </div>

        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
          ${htmlPairs}
        </div>

        <div class="divider"></div>
        <div class="sectionTitle">Observaciones</div>
        <div style="border:1px solid var(--line); border-radius:14px; padding:12px; background: rgba(0,0,0,.22);">
          ${escapeHtml(d.observaciones || "—")}
        </div>
      `;

      $("#btnBackToEdit").onclick = () => {
        state.view = "edit";
        state.selectedHistoryFolio = null;
        setSessionPill();
        renderHistory();
        renderRight();
        $("#orderPill").textContent = `Folio: ${state.order.folio}`;
      };

      $("#btnEditThis").onclick = () => {
        // cargar registro en el formulario (para editar)
        state.view = "edit";
        state.selectedHistoryFolio = null;
        state.jobType = orderObj.jobTypeKey;

        state.order = {
          folio: orderObj.folio,
          createdAt: orderObj.createdAt,
          numero: orderObj.numero ?? null,
          fecha: orderObj.fecha || "",
          trabajo: orderObj.trabajo || "",
          cliente: orderObj.cliente || "",
          data: orderObj.data || {}
        };

        $("#orderPill").textContent = `Folio: ${state.order.folio}`;
        setSessionPill();
        renderHistory();
        renderRight();
      };

      $("#btnPrintThis").onclick = () => {
        buildPrint(orderObj);
        window.print();
      };

      $("#btnDeleteThis").onclick = async () => {
        const ok = await showModal({
          title: "Eliminar registro",
          message: `¿Seguro que quieres eliminar el folio <b>${escapeHtml(orderObj.folio)}</b>?`,
          okText: "Eliminar",
          cancelText: "Cancelar",
          danger: true
        });
        if(!ok) return;

        const all = loadAll().filter(x => x.folio !== orderObj.folio);
        saveAll(all);

        state.view = "edit";
        state.selectedHistoryFolio = null;

        await showModal({
          title: "Eliminado",
          message: "Registro eliminado correctamente.",
          okText: "OK"
        });

        renderHistory();
        renderRight();
      };
    }

    // ============
    // FORM (with correct input types)
    // ============
    function baseFieldsHTML(){
      return `
        <div class="formGrid">
          ${numField("numero", "Número", "order.numero")}
          ${dateField("fecha", "Fecha")}
          ${textField("trabajo", "Trabajo")}
          ${textField("cliente", "Cliente")}
        </div>
      `;
    }

    function textField(key, label){
      const value = state.order[key] ?? "";
      return `
        <div>
          <div class="label">${label}</div>
          <input class="input" type="text" value="${escapeHtml(value)}" data-bind="order.${key}" />
        </div>
      `;
    }

    function dateField(key, label){
      const value = state.order[key] ?? "";
      return `
        <div>
          <div class="label">${label}</div>
          <input class="input" type="date" value="${escapeHtml(value)}" data-bind="order.${key}" />
        </div>
      `;
    }

    function numField(key, label, bindPath){
      const value = state.order[key];
      return `
        <div>
          <div class="label">${label}</div>
          <input class="input" type="number" inputmode="numeric" step="1" min="0"
            value="${value ?? ""}" data-bind="${bindPath}" />
        </div>
      `;
    }

    function subText(key, label){
      const value = state.order.data[key] ?? "";
      return `
        <div>
          <div class="label">${label}</div>
          <input class="input" type="text" value="${escapeHtml(value)}" data-bind="data.${key}" />
        </div>
      `;
    }

    function subNum(key, label){
      const value = state.order.data[key];
      return `
        <div>
          <div class="label">${label}</div>
          <input class="input" type="number" inputmode="numeric" step="1" min="0"
            value="${value ?? ""}" data-bind="data.${key}" />
        </div>
      `;
    }

    function subTextArea(key, label){
      const value = state.order.data[key] ?? "";
      return `
        <div>
          <div class="label">${label}</div>
          <textarea class="input" rows="4" data-bind="data.${key}">${escapeHtml(value)}</textarea>
        </div>
      `;
    }

    function check(key, label){
      return `
        <label class="check">
          <input type="checkbox" data-check="${key}">
          <span>${label}</span>
        </label>
      `;
    }

    function renderForm(){
      const area = $("#formArea");
      if(!state.jobType){
        area.innerHTML = `<div class="hint">Selecciona un tipo de trabajo para mostrar el formato.</div>`;
        return;
      }

      let html = baseFieldsHTML();

      if(state.jobType === "acabado"){
        html += `
          <div class="sectionTitle">Acabado</div>
          <div class="formGrid">
            ${subText("acabado", "Acabado")}
            ${subText("alce", "Alce")}
            ${subNum("cantidad", "Cantidad")}
            ${subText("empacado", "Empacado")}
          </div>

          <div class="divider"></div>
          <div class="sectionTitle">Acabado final</div>
          <div class="checks">
            ${check("final.cajas", "Cajas o Craft")}
            ${check("final.diurex", "Diurex")}
            ${check("final.pegamento", "Pegamento")}
            ${check("final.especiales", "Especiales")}
          </div>

          <div class="divider"></div>
          ${subTextArea("observaciones", "Observaciones")}
        `;
      }

      if(state.jobType === "suaje"){
        html += `
          <div class="sectionTitle">Suaje</div>
          <div class="formGrid">
            ${subText("suajista", "Suajista")}
            ${subText("original", "Original")}
            ${subText("trazo", "Trazo o Dibujo")}
            <div></div>
          </div>

          <div class="divider"></div>
          <div class="sectionTitle">Detalle</div>
          <div class="formGrid">
            ${subText("sacabocado", "Sacabocado")}
            ${subText("perforado", "Perforado")}
            ${subText("figura", "Figura")}
            ${subText("replecado", "Replecado")}
          </div>

          <div class="divider"></div>
          ${subTextArea("observaciones", "Observaciones")}
        `;
      }

      if(state.jobType === "impresion"){
        html += `
          <div class="sectionTitle">Impresión</div>
          <div class="formGrid">
            ${subText("prensista", "Prensista")}
            ${subNum("tiro", "Tiro")}
            ${subText("frenteVuelta", "Fte. / Vta.")}
            <div></div>
          </div>

          <div class="divider"></div>
          <div class="sectionTitle">Material / Tintas</div>
          <div class="formGrid">
            ${subNum("placas", "Placas")}
            ${subNum("tintas", "Tintas")}
            ${subText("barniz", "Barniz")}
            ${subText("tEspeciales", "T. Especiales")}
          </div>

          <div class="divider"></div>
          ${subTextArea("observaciones", "Observaciones")}
        `;
      }

      if(state.jobType === "maquina_suaje"){
        html += `
          <div class="sectionTitle">Máquina de suaje</div>
          <div class="formGrid">
            ${subText("prensista", "Prensista")}
            ${subNum("tiro", "Tiro")}
            ${subText("arreglos", "Arreglos")}
            ${subText("folioInterno", "Folio (interno)")}
          </div>

          <div class="divider"></div>
          ${subTextArea("observaciones", "Observaciones")}
        `;
      }

      area.innerHTML = html;

      // bind inputs
      area.querySelectorAll("[data-bind]").forEach(el=>{
        el.addEventListener("input", ()=>{
          const path = el.getAttribute("data-bind");
          const isNumber = el.type === "number";
          const val = isNumber ? (el.value === "" ? null : Number(el.value)) : el.value;

          if(path.startsWith("order.")){
            const k = path.split(".")[1];
            state.order[k] = val;
          }else if(path.startsWith("data.")){
            const k = path.split(".")[1];
            state.order.data[k] = val;
          }
          $("#orderPill").textContent = `Folio: ${state.order.folio}`;
        });
      });

      // bind checks
      area.querySelectorAll("input[type='checkbox'][data-check]").forEach(el=>{
        el.addEventListener("change", ()=>{
          const key = el.getAttribute("data-check");
          const [a,b] = key.split(".");
          state.order.data[a][b] = el.checked;
        });
      });

      // set checkbox initial values
      area.querySelectorAll("input[type='checkbox'][data-check]").forEach(el=>{
        const key = el.getAttribute("data-check");
        const [a,b] = key.split(".");
        el.checked = !!(state.order.data?.[a]?.[b]);
      });
    }

    // ============
    // VALIDATION / SAVE
    // ============
    function validate(){
      if(!state.employee) return "Selecciona un empleado.";
      if(!state.jobType) return "Selecciona un tipo de trabajo.";
      if(!state.order.trabajo?.trim()) return "Escribe el trabajo.";

      // ejemplo de validaciones numéricas mínimas (ajústalas si quieres)
      if(state.order.numero !== null && (Number.isNaN(state.order.numero) || state.order.numero < 0)) return "Número inválido.";
      if(state.jobType==="acabado" && state.order.data.cantidad !== null && (Number.isNaN(state.order.data.cantidad) || state.order.data.cantidad < 0)) return "Cantidad inválida.";
      if((state.jobType==="impresion" || state.jobType==="maquina_suaje") && state.order.data.tiro !== null && (Number.isNaN(state.order.data.tiro) || state.order.data.tiro < 0)) return "Tiro inválido.";
      return null;
    }

    function upsert(payload){
      const all = loadAll();
      const idx = all.findIndex(x=>x.folio===payload.folio);
      if(idx >= 0) all[idx] = payload;
      else all.push(payload);
      saveAll(all);
    }

    async function saveOrder(){
      const err = validate();
      if(err){
        await showModal({ title:"Falta información", message: err, okText:"Entendido" });
        return;
      }

      const job = JOB_TYPES.find(j=>j.key===state.jobType);
      const payload = {
        employee: state.employee,
        jobTypeKey: state.jobType,
        jobTypeTitle: job?.title || state.jobType,
        folio: state.order.folio || uid(),
        createdAt: state.order.createdAt || new Date().toISOString(),
        numero: state.order.numero,
        fecha: state.order.fecha,
        trabajo: state.order.trabajo,
        cliente: state.order.cliente,
        data: state.order.data
      };

      upsert(payload);
      renderHistory();
      await showModal({ title:"Guardado", message:"Orden guardada correctamente ✅", okText:"OK" });
    }

    // ============
    // PRINT
    // ============
    function buildPrint(orderObj){
      const d = orderObj.data || {};
      $("#pTitle").textContent = `Orden de Trabajo • ${orderObj.jobTypeTitle || "—"}`;
      $("#pMeta").textContent = [
        `Folio: ${orderObj.folio}`,
        `Fecha: ${orderObj.fecha || "—"}`,
        `Empleado: ${orderObj.employee ? `${orderObj.employee.name} (${orderObj.employee.id})` : "—"}`,
      ].join(" • ");

      const grid = $("#pGrid");
      grid.innerHTML = "";

      const pairs = [];
      pairs.push(["Número", orderObj.numero ?? "—"]);
      pairs.push(["Trabajo", orderObj.trabajo || "—"]);
      pairs.push(["Cliente", orderObj.cliente || "—"]);

      if(orderObj.jobTypeKey==="acabado"){
        pairs.push(["Acabado", d.acabado || "—"]);
        pairs.push(["Alce", d.alce || "—"]);
        pairs.push(["Cantidad", d.cantidad ?? "—"]);
        pairs.push(["Empacado", d.empacado || "—"]);
      }
      if(orderObj.jobTypeKey==="suaje"){
        pairs.push(["Suajista", d.suajista || "—"]);
        pairs.push(["Original", d.original || "—"]);
        pairs.push(["Trazo/Dibujo", d.trazo || "—"]);
      }
      if(orderObj.jobTypeKey==="impresion"){
        pairs.push(["Prensista", d.prensista || "—"]);
        pairs.push(["Tiro", d.tiro ?? "—"]);
        pairs.push(["Fte/Vta", d.frenteVuelta || "—"]);
        pairs.push(["Placas", d.placas ?? "—"]);
        pairs.push(["Tintas", d.tintas ?? "—"]);
      }
      if(orderObj.jobTypeKey==="maquina_suaje"){
        pairs.push(["Prensista", d.prensista || "—"]);
        pairs.push(["Tiro", d.tiro ?? "—"]);
        pairs.push(["Arreglos", d.arreglos || "—"]);
        pairs.push(["Folio interno", d.folioInterno || "—"]);
      }

      pairs.forEach(([k,v])=>{
        const el = document.createElement("div");
        el.className = "printLine";
        el.innerHTML = `<b>${escapeHtml(k)}:</b> ${escapeHtml(v)}`;
        grid.appendChild(el);
      });

      $("#pNotes").innerHTML = `<div class="printLine"><b>Observaciones:</b> ${escapeHtml(d.observaciones || "—")}</div>`;
    }

    // ============
    // TOP BUTTONS
    // ============
    $("#btnSave").onclick = saveOrder;

    $("#btnNew").onclick = async () => {
      if(!state.employee){
        await showModal({ title:"Selecciona empleado", message:"Primero elige un empleado para iniciar una orden.", okText:"OK" });
        return;
      }
      resetOrder();
      await showModal({ title:"Nueva orden", message:"Listo. Se creó una nueva orden ✅", okText:"OK" });
    };

    $("#btnClear").onclick = async () => {
      const ok = await showModal({
        title:"Borrar historial",
        message:"¿Seguro que quieres borrar TODO el historial guardado en esta computadora?",
        okText:"Sí, borrar",
        cancelText:"Cancelar",
        danger:true
      });
      if(!ok) return;
      saveAll([]);
      state.selectedHistoryFolio = null;
      renderHistory();
      await showModal({ title:"Listo", message:"Historial borrado.", okText:"OK" });
    };

    $("#btnPrint").onclick = async () => {
      if(state.view === "detail"){
        // ya hay un registro seleccionado; lo imprime desde detalle (se maneja ahí)
        await showModal({ title:"Tip", message:"Si estás en Detalle, usa el botón Imprimir dentro del Detalle.", okText:"OK" });
        return;
      }

      const err = validate();
      if(err){
        await showModal({ title:"Falta información", message: err, okText:"Entendido" });
        return;
      }

      // imprime el formulario actual (aunque no esté guardado)
      const job = JOB_TYPES.find(j=>j.key===state.jobType);
      const tempObj = {
        employee: state.employee,
        jobTypeKey: state.jobType,
        jobTypeTitle: job?.title || state.jobType,
        folio: state.order.folio,
        fecha: state.order.fecha,
        numero: state.order.numero,
        trabajo: state.order.trabajo,
        cliente: state.order.cliente,
        data: state.order.data
      };
      buildPrint(tempObj);
      window.print();
    };

    // ============
    // INIT
    // ============
    function init(){
      unlockEmployeeUI();
      renderEmployees("");
      renderHistory();
      resetOrder(); // crea folio y deja listo
      // pero si no hay empleado, right mostrará mensaje de elegir empleado
      renderRight();
    }

    init();
  </script>
</body>
</html>
